---
title: 'איך נבדוק האם קובץ כבר קיים ב-S3?'
date: '2025-03-11'
description: 'איך נבדוק ב-node.js האם קובץ קיים כבר ב-S3 כדי להימנע משלבים מיותרים ב-build שלנו'
---

# בדיקה האם קובץ מקומי קיים ב-S3
## למה בכלל רציתי האם קובץ קיים ב-S3?
[יש לי פרויקט שרץ ב-AWS](https://github.com/EladHeller/wiki-bot/blob/master/build/t01.cf.yaml) עם הרבה למבדות.
במהלך ה-CD של הפרויקט אני מעדכן את הלמבדות בשינויים בקוד.
כדי לעדכן את הלמבדה אני מעלה את הקוד ל-S3 ואז פונה ללמבדה עם הגרסה החדשה של הקובץ מ-S3.
אם אני יודע שהקוד לא השתנה, אני יכול לחסוך כמה דקות של עדכון כל הלמבדות שלי ובנוסף חוסך תעבורה ל-S3 שעולה (ממש מעט כסף).
## מנגנון ה-
[לכל אובייקט ב-S3 יש ETag](https://docs.aws.amazon.com/AmazonS3/latest/API/API_Object.html) שהוא מזהה ייחודי של תוכן האובייקט.
מנגנון היצירה של ה-ETag תלוי בצורה שבה הועלה הקובץ ל-S3.
אם מעלים דרך ה-sdk עם הגדרות ברירת המחדל, ה-ETag יחושב על ידי MD5.
אם הקובץ גדול מ-16 MB, לכל חתיכה של 16 MB מחושב ואז שוב מחושב על כל החתיכות ביחד, עם מספר נוסף שמסמן את מספר החתיכות.
``` ts
const chunk = 1024 * 1024 * 16; // 16MB

const md5 = (data: Buffer) => crypto.createHash('md5').update(data).digest('hex');

async function getEtagOfFile(stream: Buffer) {
  if (stream.length <= chunk) {
    return md5(stream);
  }
  const md5Chunks: string[] = [];
  const chunksNumber = Math.ceil(stream.length / chunk);
  for (let i = 0; i < chunksNumber; i += 1) {
    const chunkStream = Uint8Array.prototype.slice.call(stream, i * chunk, (i + 1) * chunk);
    md5Chunks.push(md5(chunkStream));
  }

  return `${md5(Buffer.from(md5Chunks.join(''), 'hex'))}-${chunksNumber}`;
}
```
איך אני יודע? [כתבתי את זה באינטרנט מזמן](https://stackoverflow.com/a/56382237/4517775) אז בטוח זה נכון.
